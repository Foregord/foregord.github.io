<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Customer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
      }
      .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
      }
      .autocomplete-items div:hover {
        background-color: #e9e9e9;
      }
      .autocomplete-active {
        background-color: #1e40af !important;
        color: #ffffff;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <div class="mb-8 text-center">
        <div class="bg-white rounded-2xl p-6 shadow-xl">
          <img
            src="https://tesdia.id/wp-content/uploads/2023/03/cropped-hanya-logo-DIA.webp"
            alt="Logo TesDIA"
            class="mx-auto mb-4 w-24 h-24 rounded-full shadow-lg"
          />
          <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
            TesDIA Customer Manager
          </h1>
          <p class="text-lg text-gray-600">
            Dermatoglyphics, Intelligence, Analysis
          </p>
          <p class="text-sm text-gray-500 mt-1">Form Input Data Customer</p>
        </div>
      </div>

      <div class="max-w-4xl mx-auto">
        <form id="customerForm" class="bg-white rounded-lg shadow-md p-6">
          <h2
            class="text-2xl font-bold text-gray-800 mb-6 border-b-4 border-blue-500 pb-3"
          >
            üìù Form Input Customer
          </h2>
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="no">
              No
            </label>
            <input
              type="text"
              id="no"
              name="no"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            />
          </div>

          <div class="mb-4 relative">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="nama"
            >
              Nama
            </label>
            <input
              type="text"
              id="nama"
              name="nama"
              required
              autocomplete="off"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            />
            <div id="namaAutocomplete" class="autocomplete-items hidden"></div>
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="jenis_tes"
            >
              Jenis Tes
            </label>
            <select
              id="jenis_tes"
              name="jenis_tes"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            >
              <option value="">Pilih Jenis Tes</option>
              <option value="PENDIDIKAN">PENDIDIKAN</option>
              <option value="KARIR">KARIR</option>
            </select>
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="no_hp"
            >
              No HP
            </label>
            <input
              type="text"
              id="no_hp"
              name="no_hp"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            />
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="waktu_proses"
            >
              Waktu Proses
            </label>
            <input
              type="datetime-local"
              id="waktu_proses"
              name="waktu_proses"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            />
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="status_tes"
            >
              Status Tes
            </label>
            <select
              id="status_tes"
              name="status_tes"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            >
              <option value="">Pilih Status</option>
              <option value="Gagal">Gagal</option>
              <option value="Dalam Proses">Dalam Proses</option>
              <option value="Sukses">Sukses</option>
            </select>
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="nominal_pembayaran"
            >
              Nominal Pembayaran
            </label>
            <input
              type="number"
              id="nominal_pembayaran"
              name="nominal_pembayaran"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            />
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="status_pembayaran"
            >
              Status Pembayaran
            </label>
            <select
              id="status_pembayaran"
              name="status_pembayaran"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            >
              <option value="">Pilih Status</option>
              <option value="Belum Bayar">Belum Bayar</option>
              <option value="Sudah Bayar">Sudah Bayar</option>
              <option value="Lunas">Lunas</option>
            </select>
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="akun_tes"
            >
              Akun Tes
            </label>
            <input
              type="text"
              id="akun_tes"
              name="akun_tes"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            />
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="konsultan"
            >
              Konsultan
            </label>
            <input
              type="text"
              id="konsultan"
              name="konsultan"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            />
          </div>

          <button
            type="submit"
            class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 focus:outline-none focus:shadow-outline"
          >
            Simpan Data Customer
          </button>
        </form>

        <div id="responseMessage" class="mt-4 text-center"></div>

        <!-- Tabel Data Customer -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">
              üìä Data Customer TesDIA
            </h2>
            <div class="flex items-center space-x-4">
              <input
                type="text"
                id="searchInput"
                placeholder="üîç Cari data customer..."
                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
              />
              <select
                id="limitSelect"
                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
              >
                <option value="10">10 per halaman</option>
                <option value="20">20 per halaman</option>
                <option value="30">30 per halaman</option>
                <option value="50">50 per halaman</option>
              </select>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table id="customerTable" class="w-full table-auto">
              <thead>
                <tr class="bg-gray-200">
                  <th class="px-4 py-2 text-left">No</th>
                  <th class="px-4 py-2 text-left">Nama</th>
                  <th class="px-4 py-2 text-left">Jenis Tes</th>
                  <th class="px-4 py-2 text-left">No HP</th>
                  <th class="px-4 py-2 text-left">Status Tes</th>
                  <th class="px-4 py-2 text-left">Nominal</th>
                  <th class="px-4 py-2 text-left">Status Bayar</th>
                </tr>
              </thead>
              <tbody id="customerTableBody">
                <!-- Data akan di-load di sini -->
              </tbody>
            </table>
          </div>

          <div id="pagination" class="mt-4 flex justify-between items-center">
            <div id="paginationInfo"></div>
            <div class="flex space-x-2">
              <button
                id="prevBtn"
                class="px-3 py-1 border rounded hover:bg-gray-100"
              >
                Previous
              </button>
              <div id="pageNumbers" class="flex space-x-1"></div>
              <button
                id="nextBtn"
                class="px-3 py-1 border rounded hover:bg-gray-100"
              >
                Next
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxqK3O6H9lQHLpHvXkW0eDcJm9-ffbgRIb8xTkz24qQCPAkDDKp_8XGvvj0-pge0lMmdg/exec";
      let customerNames = [];

      // Variables for pagination
      let currentPage = 1;
      let currentLimit = 10;
      let totalPages = 1;
      let searchQuery = "";

      // Load existing customer names using JSONP approach
      async function loadCustomerNames() {
        try {
          // Use a simple approach with iframe for loading data
          const data = await loadDataFromGoogleSheets("customer");
          if (data && data.length > 0) {
            customerNames = data
              .map((item) => item.nama)
              .filter((name) => name && name.trim() !== "");

            // Update autocomplete
            autocomplete(document.getElementById("nama"), customerNames);
          }
        } catch (error) {
          console.error("Error loading customer names:", error);
        }
      }

      // Load table data with pagination using JSONP approach
      async function loadTableData() {
        try {
          const data = await loadDataFromGoogleSheets(
            `customer&pagination=true&page=${currentPage}&limit=${currentLimit}&search=${encodeURIComponent(
              searchQuery
            )}`
          );

          if (data && data.data) {
            displayTableData(data.data);
            updatePagination(data.pagination);
          } else if (data && Array.isArray(data)) {
            // Fallback untuk data tanpa pagination
            const startIndex = (currentPage - 1) * currentLimit;
            const endIndex = startIndex + currentLimit;
            const paginatedData = data.slice(startIndex, endIndex);

            displayTableData(paginatedData);
            updatePagination({
              currentPage: currentPage,
              totalPages: Math.ceil(data.length / currentLimit),
              totalItems: data.length,
            });
          }
        } catch (error) {
          console.error("Error loading table data:", error);
          // Show error message in table
          const tbody = document.getElementById("customerTableBody");
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center py-4 text-red-500">Error loading data. Please refresh the page.</td></tr>';
        }
      }

      // Generic function to load data from Google Sheets
      async function loadDataFromGoogleSheets(params) {
        // Try JSONP first
        try {
          return await loadDataViaJSONP(params);
        } catch (error) {
          console.log("JSONP failed, trying fallback method:", error);
          // Fallback to basic fetch for simple data loading
          try {
            return await loadDataViaFetch(params);
          } catch (fetchError) {
            console.error("All methods failed:", fetchError);
            throw fetchError;
          }
        }
      }

      // Load data using JSONP method
      async function loadDataViaJSONP(params) {
        return new Promise((resolve, reject) => {
          const callbackName =
            "jsonp_callback_" + Math.round(100000 * Math.random());

          // Create script tag for JSONP
          const script = document.createElement("script");
          const url = `${APPS_SCRIPT_URL}?sheet=${params}&callback=${callbackName}`;

          // Define callback function
          window[callbackName] = function (data) {
            // Clean up
            document.head.removeChild(script);
            delete window[callbackName];
            resolve(data);
          };

          // Handle errors
          script.onerror = function () {
            document.head.removeChild(script);
            delete window[callbackName];
            reject(new Error("JSONP request failed"));
          };

          script.src = url;
          document.head.appendChild(script);

          // Timeout after 10 seconds
          setTimeout(() => {
            if (window[callbackName]) {
              document.head.removeChild(script);
              delete window[callbackName];
              reject(new Error("JSONP request timeout"));
            }
          }, 10000);
        });
      }

      // Fallback method using fetch (may have CORS issues but worth trying)
      async function loadDataViaFetch(params) {
        const response = await fetch(`${APPS_SCRIPT_URL}?sheet=${params}`, {
          method: "GET",
          mode: "cors",
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        return result;
      }

      // Display table data
      function displayTableData(data) {
        const tbody = document.getElementById("customerTableBody");
        tbody.innerHTML = "";

        if (data.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center py-4 text-gray-500">Tidak ada data</td></tr>';
          return;
        }

        data.forEach((row) => {
          const tr = document.createElement("tr");
          tr.className = "border-b hover:bg-gray-50";
          tr.innerHTML = `
                    <td class="px-4 py-2">${row.no}</td>
                    <td class="px-4 py-2">${row.nama}</td>
                    <td class="px-4 py-2">${row.jenistes}</td>
                    <td class="px-4 py-2">${row.nohp}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 text-xs rounded-full ${
                          row.statustes === "Selesai"
                            ? "bg-green-100 text-green-800"
                            : row.statustes === "Dalam Proses"
                            ? "bg-yellow-100 text-yellow-800"
                            : "bg-red-100 text-red-800"
                        }">${row.statustes}</span>
                    </td>
                    <td class="px-4 py-2">Rp ${parseInt(
                      row.nominalpembayaran || 0
                    ).toLocaleString("id-ID")}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 text-xs rounded-full ${
                          row.statuspembayaran === "Lunas"
                            ? "bg-green-100 text-green-800"
                            : row.statuspembayaran === "Sudah Bayar"
                            ? "bg-blue-100 text-blue-800"
                            : "bg-red-100 text-red-800"
                        }">${row.statuspembayaran}</span>
                    </td>
                `;
          tbody.appendChild(tr);
        });
      }

      // Update pagination UI
      function updatePagination(pagination) {
        currentPage = pagination.currentPage;
        totalPages = pagination.totalPages;

        document.getElementById("paginationInfo").textContent = `Menampilkan ${
          (currentPage - 1) * currentLimit + 1
        } - ${Math.min(
          currentPage * currentLimit,
          pagination.totalItems
        )} dari ${pagination.totalItems} data`;

        // Update page numbers
        const pageNumbers = document.getElementById("pageNumbers");
        pageNumbers.innerHTML = "";

        const maxPagesToShow = 5;
        let startPage = Math.max(
          1,
          currentPage - Math.floor(maxPagesToShow / 2)
        );
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
          startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.className = `px-3 py-1 border rounded ${
            i === currentPage ? "bg-blue-500 text-white" : "hover:bg-gray-100"
          }`;
          btn.onclick = () => goToPage(i);
          pageNumbers.appendChild(btn);
        }

        document.getElementById("prevBtn").disabled = currentPage === 1;
        document.getElementById("nextBtn").disabled =
          currentPage === totalPages;
      }

      // Pagination controls
      function goToPage(page) {
        currentPage = page;
        loadTableData();
      }

      document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          loadTableData();
        }
      });

      document.getElementById("nextBtn").addEventListener("click", () => {
        if (currentPage < totalPages) {
          currentPage++;
          loadTableData();
        }
      });

      document.getElementById("limitSelect").addEventListener("change", (e) => {
        currentLimit = parseInt(e.target.value);
        currentPage = 1;
        loadTableData();
      });

      document.getElementById("searchInput").addEventListener("input", (e) => {
        searchQuery = e.target.value;
        currentPage = 1;
        loadTableData();
      });

      // Autocomplete functionality
      function autocomplete(inp, arr) {
        let currentFocus;

        inp.addEventListener("input", function (e) {
          let a,
            b,
            i,
            val = this.value;
          closeAllLists();
          if (!val) return false;
          currentFocus = -1;
          a = document.createElement("DIV");
          a.setAttribute("id", this.id + "AutocompleteList");
          a.setAttribute("class", "autocomplete-items");
          this.parentNode.appendChild(a);

          for (i = 0; i < arr.length; i++) {
            if (
              arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()
            ) {
              b = document.createElement("DIV");
              b.innerHTML =
                "<strong>" + arr[i].substr(0, val.length) + "</strong>";
              b.innerHTML += arr[i].substr(val.length);
              b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
              b.addEventListener("click", function (e) {
                inp.value = this.getElementsByTagName("input")[0].value;
                closeAllLists();
              });
              a.appendChild(b);
            }
          }
        });

        inp.addEventListener("keydown", function (e) {
          var x = document.getElementById(this.id + "AutocompleteList");
          if (x) x = x.getElementsByTagName("div");
          if (e.keyCode == 40) {
            currentFocus++;
            addActive(x);
          } else if (e.keyCode == 38) {
            currentFocus--;
            addActive(x);
          } else if (e.keyCode == 13) {
            e.preventDefault();
            if (currentFocus > -1) {
              if (x) x[currentFocus].click();
            }
          }
        });

        function addActive(x) {
          if (!x) return false;
          removeActive(x);
          if (currentFocus >= x.length) currentFocus = 0;
          if (currentFocus < 0) currentFocus = x.length - 1;
          x[currentFocus].classList.add("autocomplete-active");
        }

        function removeActive(x) {
          for (var i = 0; i < x.length; i++) {
            x[i].classList.remove("autocomplete-active");
          }
        }

        function closeAllLists(elmnt) {
          var x = document.getElementsByClassName("autocomplete-items");
          for (var i = 0; i < x.length; i++) {
            if (elmnt != x[i] && elmnt != inp) {
              x[i].parentNode.removeChild(x[i]);
            }
          }
        }

        document.addEventListener("click", function (e) {
          closeAllLists(e.target);
        });
      }

      // Form submission using iframe to avoid CORS
      document
        .getElementById("customerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData);

          // Show loading message
          const messageDiv = document.getElementById("responseMessage");
          messageDiv.innerHTML =
            '<div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded">‚è≥ Menyimpan data...</div>';

          try {
            await saveToGoogleSheets(data);

            messageDiv.innerHTML =
              '<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">‚úÖ Data berhasil disimpan!</div>';
            e.target.reset();

            // Reload table data and customer names
            setTimeout(() => {
              loadTableData();
              loadCustomerNames();
            }, 1000);
          } catch (error) {
            console.error("Error saving data:", error);
            messageDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">‚ùå Error: ${error.message}</div>`;
          }
        });

      // Save to Google Sheets using form submission to avoid CORS
      async function saveToGoogleSheets(data) {
        return new Promise((resolve, reject) => {
          // Create a hidden iframe
          const iframe = document.createElement("iframe");
          iframe.style.display = "none";
          iframe.name = "customerFormTarget";
          document.body.appendChild(iframe);

          // Create a hidden form
          const form = document.createElement("form");
          form.method = "POST";
          form.action = APPS_SCRIPT_URL;
          form.target = "customerFormTarget";
          form.style.display = "none";

          // Add sheet parameter
          const sheetInput = document.createElement("input");
          sheetInput.type = "hidden";
          sheetInput.name = "sheet";
          sheetInput.value = "customer";
          form.appendChild(sheetInput);

          // Add all data fields
          Object.keys(data).forEach((key) => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = key;
            input.value = data[key] || "";
            form.appendChild(input);
          });

          // Handle iframe load event
          iframe.onload = () => {
            try {
              // Clean up
              document.body.removeChild(iframe);
              document.body.removeChild(form);
              resolve();
            } catch (error) {
              reject(error);
            }
          };

          iframe.onerror = () => {
            document.body.removeChild(iframe);
            document.body.removeChild(form);
            reject(new Error("Gagal mengirim data ke Google Sheets"));
          };

          // Submit the form
          document.body.appendChild(form);
          form.submit();
        });
      }

      // Initialize
      loadCustomerNames();
      loadTableData(); // Load table data on page load
      autocomplete(document.getElementById("nama"), customerNames);
    </script>
  </body>
</html>
