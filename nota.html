<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nota Pembayaran - TesDIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @media print {
        .no-print {
          display: none !important;
        }
        body {
          background: white !important;
        }
        .print-area {
          box-shadow: none !important;
          border: 1px solid #ddd !important;
        }
      }

      .nota-background {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Form Input Nominal Asli -->
    <div id="inputForm" class="container mx-auto px-4 py-8">
      <div class="max-w-md mx-auto bg-white rounded-2xl shadow-xl p-6">
        <div class="text-center mb-6">
          <img
            src="https://tesdia.id/wp-content/uploads/2023/03/cropped-hanya-logo-DIA.webp"
            alt="Logo TesDIA"
            class="mx-auto mb-4 w-20 h-20 rounded-full shadow-lg"
          />
          <h1 class="text-2xl font-bold text-gray-800 mb-2">
            Input Nominal Pembayaran
          </h1>
          <p class="text-sm text-gray-600">
            Masukkan nominal asli pembayaran untuk nota
          </p>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">
              Nama Customer
            </label>
            <input
              type="text"
              id="customerName"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
              readonly
            />
          </div>

          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">
              Jenis Tes
            </label>
            <input
              type="text"
              id="jenisTest"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
              readonly
            />
          </div>

          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">
              Harga Asli Tes <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="nominalAsli"
              placeholder="Masukkan harga asli tes (contoh: 350000)"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
              required
            />
          </div>

          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">
              Diskon/Potongan <span class="text-gray-500">(Opsional)</span>
            </label>
            <input
              type="number"
              id="diskonAmount"
              placeholder="Masukkan jumlah diskon (contoh: 100000)"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
              value="0"
            />
          </div>

          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">
              Total Yang Harus Dibayar
            </label>
            <input
              type="text"
              id="totalBayar"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 font-bold text-green-600"
              readonly
              placeholder="Akan dihitung otomatis"
            />
          </div>

          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">
              Metode Pembayaran
            </label>
            <select
              id="metodePembayaran"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
              required
            >
              <option value="">Pilih Metode Pembayaran</option>
              <option value="Cash">Cash</option>
              <option value="Transfer Bank">Transfer Bank</option>
              <option value="E-Wallet">E-Wallet</option>
              <option value="Kartu Kredit">Kartu Kredit</option>
            </select>
          </div>

          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2">
              Catatan (Opsional)
            </label>
            <textarea
              id="catatan"
              placeholder="Catatan tambahan..."
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
              rows="3"
            ></textarea>
          </div>

          <button
            onclick="generateNota()"
            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200"
          >
            üßæ Generate Nota
          </button>

          <button
            onclick="window.history.back()"
            class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200"
          >
            ‚Üê Kembali
          </button>
        </div>
      </div>
    </div>

    <!-- Nota Digital -->
    <div id="notaDigital" class="hidden">
      <div class="container mx-auto px-4 py-8">
        <!-- Control Buttons (No Print) -->
        <div class="no-print max-w-2xl mx-auto mb-6 flex gap-4 justify-center">
          <button
            onclick="printNota()"
            class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors duration-200"
          >
            üñ®Ô∏è Print Nota
          </button>
          <button
            onclick="shareWhatsApp()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors duration-200"
          >
            üì± Share WhatsApp
          </button>
          <button
            onclick="editNota()"
            class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg font-semibold transition-colors duration-200"
          >
            ‚úèÔ∏è Edit
          </button>
        </div>

        <!-- Nota Content -->
        <div
          id="notaContent"
          class="print-area max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden"
        >
          <!-- Header -->
          <div class="nota-background text-white p-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <img
                  src="https://tesdia.id/wp-content/uploads/2023/03/cropped-hanya-logo-DIA.webp"
                  alt="Logo TesDIA"
                  class="w-16 h-16 rounded-full bg-white p-2"
                />
                <div>
                  <h1 class="text-2xl font-bold">TesDIA</h1>
                  <p class="text-sm opacity-90">
                    Dermatoglyphics, Intelligence, Analysis
                  </p>
                </div>
              </div>
              <div class="text-right">
                <h2 class="text-xl font-bold">NOTA PEMBAYARAN</h2>
                <p class="text-sm opacity-90" id="notaDate"></p>
              </div>
            </div>
          </div>

          <!-- Customer Info -->
          <div class="p-6 border-b-2 border-gray-100">
            <div class="grid grid-cols-2 gap-6">
              <div>
                <h3 class="text-lg font-bold text-gray-800 mb-3">
                  Informasi Customer
                </h3>
                <div class="space-y-2">
                  <div class="flex">
                    <span class="w-24 text-gray-600 text-sm">No Customer:</span>
                    <span class="font-semibold text-sm" id="notaNo"></span>
                  </div>
                  <div class="flex">
                    <span class="w-24 text-gray-600 text-sm">Nama:</span>
                    <span class="font-semibold text-sm" id="notaNama"></span>
                  </div>
                  <div class="flex">
                    <span class="w-24 text-gray-600 text-sm">No HP:</span>
                    <span class="font-semibold text-sm" id="notaHP"></span>
                  </div>
                </div>
              </div>
              <div>
                <h3 class="text-lg font-bold text-gray-800 mb-3">Detail Tes</h3>
                <div class="space-y-2">
                  <div class="flex">
                    <span class="w-24 text-gray-600 text-sm">Jenis Tes:</span>
                    <span class="font-semibold text-sm" id="notaJenis"></span>
                  </div>
                  <div class="flex">
                    <span class="w-24 text-gray-600 text-sm">Status:</span>
                    <span
                      class="px-2 py-1 rounded-full text-xs font-semibold"
                      id="notaStatus"
                    ></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Details -->
          <div class="p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">
              Detail Pembayaran
            </h3>
            <div class="bg-gray-50 rounded-lg p-4">
              <div class="grid grid-cols-2 gap-4">
                <div class="space-y-3">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Biaya Tes:</span>
                    <span class="font-semibold" id="notaBiayaTes"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Metode Bayar:</span>
                    <span class="font-semibold" id="notaMetode"></span>
                  </div>
                </div>
                <div class="space-y-3">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Diskon/Potongan:</span>
                    <span
                      class="font-semibold text-red-600"
                      id="notaDiskon"
                    ></span>
                  </div>
                  <div class="flex justify-between border-t pt-2">
                    <span class="text-lg font-bold text-gray-800"
                      >Total Bayar:</span
                    >
                    <span
                      class="text-lg font-bold text-green-600"
                      id="notaTotal"
                    ></span>
                  </div>
                </div>
              </div>
            </div>

            <div id="notaCatatanSection" class="mt-4 hidden">
              <h4 class="font-semibold text-gray-700 mb-2">Catatan:</h4>
              <p
                class="text-gray-600 text-sm bg-yellow-50 p-3 rounded"
                id="notaCatatan"
              ></p>
            </div>
          </div>

          <!-- Footer -->
          <div class="bg-gray-50 p-6 text-center">
            <p class="text-sm text-gray-600 mb-2">
              Terima kasih telah menggunakan layanan TesDIA
            </p>
            <p class="text-xs text-gray-500">
              Website: tesdia.id | Email: info@tesdia.id
            </p>
            <p class="text-xs text-gray-400 mt-2">
              Nota digital ini sah dan dapat digunakan sebagai bukti pembayaran
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      let customerData = {};

      // Load customer data from URL parameter
      window.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const data = urlParams.get("data");

        if (data) {
          try {
            customerData = JSON.parse(decodeURIComponent(data));
            populateForm();
          } catch (error) {
            console.error("Error parsing customer data:", error);
            alert("Data customer tidak valid");
            window.history.back();
          }
        } else {
          alert("Data customer tidak ditemukan");
          window.history.back();
        }
      });

      function populateForm() {
        document.getElementById("customerName").value = customerData.nama || "";
        document.getElementById("jenisTest").value =
          customerData.jenistes || "";

        // Add event listeners for auto-calculation
        document
          .getElementById("nominalAsli")
          .addEventListener("input", calculateTotal);
        document
          .getElementById("diskonAmount")
          .addEventListener("input", calculateTotal);
      }

      function calculateTotal() {
        const nominalAsli =
          parseInt(document.getElementById("nominalAsli").value) || 0;
        const diskon =
          parseInt(document.getElementById("diskonAmount").value) || 0;
        const total = nominalAsli - diskon;

        if (nominalAsli > 0) {
          document.getElementById(
            "totalBayar"
          ).value = `Rp ${total.toLocaleString("id-ID")}`;
        } else {
          document.getElementById("totalBayar").value = "";
        }
      }

      function generateNota() {
        const nominalAsli = document.getElementById("nominalAsli").value;
        const diskonAmount = document.getElementById("diskonAmount").value;
        const metodePembayaran =
          document.getElementById("metodePembayaran").value;
        const catatan = document.getElementById("catatan").value;

        if (!nominalAsli || !metodePembayaran) {
          alert("Mohon lengkapi harga asli tes dan metode pembayaran");
          return;
        }

        // Calculate totals
        const nominalAsliValue = parseInt(nominalAsli);
        const diskonValue = parseInt(diskonAmount) || 0;
        const totalBayar = nominalAsliValue - diskonValue;

        // Populate nota
        document.getElementById("notaDate").textContent =
          new Date().toLocaleDateString("id-ID", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });

        document.getElementById("notaNo").textContent = customerData.no || "";
        document.getElementById("notaNama").textContent =
          customerData.nama || "";
        document.getElementById("notaHP").textContent = customerData.nohp || "";
        document.getElementById("notaJenis").textContent =
          customerData.jenistes || "";

        // Status styling
        const statusElement = document.getElementById("notaStatus");
        statusElement.textContent = customerData.statusPembayaran || "";
        if (customerData.statusPembayaran === "Lunas") {
          statusElement.className =
            "px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800";
        } else if (customerData.statusPembayaran === "Sudah Bayar") {
          statusElement.className =
            "px-2 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800";
        } else {
          statusElement.className =
            "px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800";
        }

        document.getElementById(
          "notaBiayaTes"
        ).textContent = `Rp ${nominalAsliValue.toLocaleString("id-ID")}`;
        document.getElementById("notaMetode").textContent = metodePembayaran;
        document.getElementById("notaDiskon").textContent =
          diskonValue > 0
            ? `- Rp ${diskonValue.toLocaleString("id-ID")}`
            : "Rp 0";
        document.getElementById(
          "notaTotal"
        ).textContent = `Rp ${totalBayar.toLocaleString("id-ID")}`;

        // Show/hide catatan
        if (catatan.trim()) {
          document
            .getElementById("notaCatatanSection")
            .classList.remove("hidden");
          document.getElementById("notaCatatan").textContent = catatan;
        } else {
          document.getElementById("notaCatatanSection").classList.add("hidden");
        }

        // Store values for WhatsApp sharing
        window.notaData = {
          customerName: customerData.nama || "",
          jenisTest: customerData.jenistes || "",
          hargaAsli: nominalAsliValue,
          diskon: diskonValue,
          totalBayar: totalBayar,
          metodePembayaran: metodePembayaran,
        };

        // Set document title untuk nama file PDF
        const customerName = customerData.nama || "Customer";
        document.title = `${customerName} - Nota Pembayaran TesDIA`;

        // Show nota, hide form
        document.getElementById("inputForm").classList.add("hidden");
        document.getElementById("notaDigital").classList.remove("hidden");
      }

      function editNota() {
        document.getElementById("notaDigital").classList.add("hidden");
        document.getElementById("inputForm").classList.remove("hidden");
      }

      function printNota() {
        // Set document title sebelum print untuk nama file PDF
        const customerName = customerData.nama || "Customer";
        const originalTitle = document.title;
        document.title = `${customerName} - Nota Pembayaran TesDIA`;

        // Print dengan delay singkat untuk memastikan title terupdate
        setTimeout(() => {
          window.print();
          // Restore original title setelah print
          setTimeout(() => {
            document.title = originalTitle;
          }, 1000);
        }, 100);
      }

      function shareWhatsApp() {
        const data = window.notaData || {};
        const customerName = data.customerName || "";
        const jenisTest = data.jenisTest || "";
        const hargaAsli = data.hargaAsli || 0;
        const diskon = data.diskon || 0;
        const totalBayar = data.totalBayar || 0;
        const metodePembayaran = data.metodePembayaran || "";

        let message = `*NOTA PEMBAYARAN - TesDIA*

üè• *Dermatoglyphics, Intelligence, Analysis*

üë§ *Customer:* ${customerName}
üìã *Jenis Tes:* ${jenisTest}
üí∞ *Harga Asli:* Rp ${hargaAsli.toLocaleString("id-ID")}`;

        if (diskon > 0) {
          message += `
üí∏ *Diskon:* Rp ${diskon.toLocaleString("id-ID")}`;
        }

        message += `
‚úÖ *Total Bayar:* Rp ${totalBayar.toLocaleString("id-ID")}
üí≥ *Metode Bayar:* ${metodePembayaran}
üìÖ *Tanggal:* ${new Date().toLocaleDateString("id-ID")}

üôè Terima kasih telah menggunakan layanan TesDIA
üåê Website: tesdia.id`;

        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(
          message
        )}`;
        window.open(whatsappUrl, "_blank");
      }
    </script>
  </body>
</html>
