<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/x-icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📊</text></svg>"
    />
    <title>TESDIA DATA MANAGER</title>
    <!-- Meta untuk mencegah indexing Google -->
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet" />
    <meta name="googlebot" content="noindex, nofollow" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .gradient-primary {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }

      .gradient-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      }

      .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
    </style>
  </head>
  <body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
      <!-- Header -->
      <div
        class="gradient-primary rounded-2xl p-6 mb-6 text-center text-white shadow-2xl"
      >
        <img
          src="https://tesdia.id/wp-content/uploads/2023/03/cropped-hanya-logo-DIA.webp"
          alt="Logo Tesdia"
          class="mx-auto mb-4 w-24 h-24 rounded-full shadow-lg"
        />
        <h1 class="text-3xl md:text-4xl font-bold mb-2">
          Tesdia Data Manager Bandung
        </h1>
      </div>

      <!-- Main Content -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Form Section -->
        <div class="bg-white rounded-2xl p-6 shadow-2xl">
          <h2
            class="text-2xl font-bold text-gray-800 mb-6 border-b-4 border-primary pb-3"
          >
            Input Data
          </h2>
          <!-- Success Message -->
          <div
            id="successMessage"
            class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-4"
          >
            <span class="font-medium">✅ Data berhasil disimpan!</span>
          </div>
          <!-- Error Message -->
          <div
            id="errorMessage"
            class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4"
          >
            <span class="font-medium"
              >❌ Mohon lengkapi semua field yang diperlukan!</span
            >
          </div>
          <!-- Loading Message -->
          <div
            id="loadingMessage"
            class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg mb-4"
          >
            <span class="font-medium"
              >⏳ Menyimpan data ke Google Sheets...</span
            >
          </div>

          <form id="dataForm" class="space-y-4">
            <!-- Nama -->
            <div>
              <label
                for="nama"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                Nama Lengkap *
              </label>
              <input
                type="text"
                id="nama"
                name="nama"
                required
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-200"
              />
            </div>

            <!-- No HP -->
            <div>
              <label
                for="nohp"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                No. HP *
              </label>
              <input
                type="tel"
                id="nohp"
                name="nohp"
                required
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-200"
              />
            </div>

            <!-- Sekolah -->
            <div>
              <label
                for="sekolah"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                Sekolah *
              </label>
              <input
                type="text"
                id="sekolah"
                name="sekolah"
                required
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-200"
              />
            </div>

            <!-- Jabatan -->
            <div>
              <label
                for="jabatan"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                Jabatan
              </label>
              <input
                type="text"
                id="jabatan"
                name="jabatan"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-200"
              />
            </div>

            <!-- Tipe Jari -->
            <div>
              <label
                for="tipejari"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                Tipe Jari *
              </label>
              <select
                id="tipejari"
                name="tipejari"
                required
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-200"
              >
                <option value="">Pilih tipe jari</option>
                <option value="jempol">Jempol</option>
                <option value="telunjuk">Telunjuk</option>
                <option value="tengah">Tengah</option>
                <option value="manis">Manis</option>
                <option value="kelingking">Kelingking</option>
                <option value="Belum di tes">Belum di tes</option>
              </select>
            </div>

            <!-- Indikasi -->
            <div>
              <label
                for="indikasi"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                Indikasi *
              </label>
              <select
                id="indikasi"
                name="indikasi"
                required
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-200"
              >
                <option value="">Pilih indikasi</option>
                <option value="positif">Positif</option>
                <option value="negatif">Negatif</option>
              </select>
            </div>

            <!-- Keterangan -->
            <div>
              <label
                for="keterangan"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                Keterangan
              </label>
              <select
                id="keterangan"
                name="keterangan"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-200"
              >
                <option value="">Pilih keterangan</option>
                <option value="Seminar Parenting">Seminar Parenting</option>
                <option value="Seminar Guru-Guru">Seminar Guru-Guru</option>
                <option value="Workshop">Workshop</option>
                <option value="Sosialisasi">Sosialisasi</option>
                <option value="Pengetesan">Pengetesan</option>
              </select>
            </div>

            <!-- Follow Up -->
            <div>
              <label
                for="followup"
                class="block text-sm font-semibold text-gray-700 mb-2"
              >
                Follow Up Date
              </label>
              <input
                type="date"
                id="followup"
                name="followup"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-200"
              />
            </div>

            <!-- Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 pt-4">
              <button
                type="submit"
                class="gradient-primary text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center gap-2"
              >
                <span>💾</span>
                Simpan Data
              </button>
              <button
                type="button"
                onclick="clearForm()"
                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center gap-2"
              >
                <span>🗑️</span>
                Clear Form
              </button>
            </div>
          </form>
        </div>

        <!-- Data Section -->
        <div class="bg-white rounded-2xl p-6 shadow-2xl">
          <h2
            class="text-2xl font-bold text-gray-800 mb-6 border-b-4 border-primary pb-3"
          >
            Data Tersimpan
          </h2>

          <!-- Stats Cards -->
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
            <div class="gradient-bg text-white p-4 rounded-lg text-center">
              <div class="text-2xl font-bold" id="totalData">0</div>
              <div class="text-sm opacity-90">Total Data</div>
            </div>
            <div class="gradient-primary text-white p-4 rounded-lg text-center">
              <div class="text-2xl font-bold" id="totalPositif">0</div>
              <div class="text-sm opacity-90">Positif</div>
            </div>
            <div
              class="bg-green-500 text-white p-4 rounded-lg text-center col-span-2 md:col-span-1"
            >
              <div class="text-2xl font-bold" id="totalNegatif">0</div>
              <div class="text-sm opacity-90">Negatif</div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-3 mb-6">
            <button
              onclick="syncWithGoogleSheets()"
              class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center gap-2 text-sm"
            >
              <span>🔄</span>
              Sync Google Sheets
            </button>
            <button
              onclick="exportData()"
              class="gradient-primary text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center gap-2 text-sm"
            >
              <span>📤</span>
              Export JSON
            </button>
            <button
              onclick="importData()"
              class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center gap-2 text-sm"
            >
              <span>📥</span>
              Import JSON
            </button>
            <button
              onclick="clearAllData()"
              class="gradient-danger text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center gap-2 text-sm"
            >
              <span>🗑️</span>
              Hapus Semua
            </button>
          </div>

          <input
            type="file"
            id="fileInput"
            accept=".json"
            class="hidden"
            onchange="handleFileImport(event)"
          />

          <!-- Data Display -->
          <div id="dataDisplay" class="overflow-x-auto"></div>
        </div>
      </div>
    </div>

    <script>
      // GANTI URL INI DENGAN URL APPS SCRIPT ANDA
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbymC8QtwmU4mNQ_VvdnIzjkNjXNyVZzATo6UjzDOTCHc-4DVNGnEk6xskIUrYxwq_sI/exec";

      // Data storage (hybrid: localStorage + Google Sheets)
      let dataStore = JSON.parse(localStorage.getItem("userData") || "[]");
      let isOnline = navigator.onLine;

      // Fungsi untuk menampilkan pesan
      function showMessage(messageId) {
        const message = document.getElementById(messageId);
        if (message) {
          message.classList.remove("hidden");
          setTimeout(() => {
            message.classList.add("hidden");
          }, 3000);
        }
      }

      // Fungsi untuk menampilkan loading
      function showLoading(show) {
        const loadingMessage = document.getElementById("loadingMessage");
        if (loadingMessage) {
          if (show) {
            loadingMessage.classList.remove("hidden");
          } else {
            loadingMessage.classList.add("hidden");
          }
        }
      }

      // Fungsi untuk mengupdate statistik
      function updateStats() {
        const totalData = dataStore.length;
        const totalPositif = dataStore.filter(
          (item) => item.indikasi === "positif"
        ).length;
        const totalNegatif = dataStore.filter(
          (item) => item.indikasi === "negatif"
        ).length;

        const totalDataElement = document.getElementById("totalData");
        const totalPositifElement = document.getElementById("totalPositif");
        const totalNegatifElement = document.getElementById("totalNegatif");

        if (totalDataElement) totalDataElement.textContent = totalData;
        if (totalPositifElement) totalPositifElement.textContent = totalPositif;
        if (totalNegatifElement) totalNegatifElement.textContent = totalNegatif;
      }

      document
        .getElementById("dataForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(e.target);
          const data = {
            id: Date.now(),
            timestamp: new Date().toLocaleString("id-ID"),
            nama: formData.get("nama"),
            nohp: formData.get("nohp"),
            sekolah: formData.get("sekolah"),
            jabatan: formData.get("jabatan"),
            tipejari: formData.get("tipejari"),
            indikasi: formData.get("indikasi"),
            keterangan: formData.get("keterangan"),
            followup: formData.get("followup"),
          };

          // Validasi - field wajib
          if (
            !data.nama ||
            !data.nohp ||
            !data.sekolah ||
            !data.tipejari ||
            !data.indikasi
          ) {
            showMessage("errorMessage");
            return;
          }

          // Tampilkan loading
          showLoading(true);

          try {
            // Kirim data ke Google Sheets menggunakan JSON
            const response = await fetch(APPS_SCRIPT_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            console.log("Response status:", response.status);
            console.log("Response headers:", response.headers);

            if (response.ok) {
              const result = await response.json();
              console.log("Response dari Google Sheets:", result);

              if (result.success) {
                console.log("Data berhasil disimpan ke Google Sheets");
              } else {
                console.error("Error dari Google Sheets:", result.message);
              }
            } else {
              console.error(
                "HTTP Error:",
                response.status,
                response.statusText
              );
            }
          } catch (error) {
            console.error("Error saving to Google Sheets:", error);
          }

          // Simpan ke localStorage (selalu berhasil)
          dataStore.push(data);
          localStorage.setItem("userData", JSON.stringify(dataStore));

          // Reset form dan update display
          e.target.reset();
          showMessage("successMessage");
          updateDataDisplay();
          showLoading(false);
        });

      // Update Google Apps Script method
      async function syncWithGoogleSheets() {
        showLoading(true);
        try {
          const response = await fetch(APPS_SCRIPT_URL + "?action=get", {
            method: "GET",
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              // Sync data dari Google Sheets ke localStorage
              dataStore = result.data || [];
              localStorage.setItem("userData", JSON.stringify(dataStore));
              updateDataDisplay();
              alert("Sync berhasil!");
            } else {
              alert("Gagal sync: " + result.message);
            }
          } else {
            alert("Gagal terhubung ke Google Sheets");
          }
        } catch (error) {
          console.error("Error syncing:", error);
          alert(
            "Gagal melakukan sync dengan Google Sheets. Periksa koneksi internet."
          );
        } finally {
          showLoading(false);
        }
      }

      function clearForm() {
        document.getElementById("dataForm").reset();
      }

      function updateDataDisplay() {
        const display = document.getElementById("dataDisplay");

        if (dataStore.length === 0) {
          display.innerHTML =
            '<div class="text-center text-gray-500 py-8 italic">Belum ada data yang tersimpan</div>';
          updateStats();
          return;
        }

        let html = '<div class="overflow-x-auto">';
        html +=
          '<table class="min-w-full bg-white rounded-lg overflow-hidden shadow-lg">';
        html += '<thead class="gradient-bg text-white">';
        html += "<tr>";
        html +=
          '<th class="px-4 py-3 text-left text-sm font-semibold">Timestamp</th>';
        html +=
          '<th class="px-4 py-3 text-left text-sm font-semibold">Nama</th>';
        html +=
          '<th class="px-4 py-3 text-left text-sm font-semibold hidden sm:table-cell">No. HP</th>';
        html +=
          '<th class="px-4 py-3 text-left text-sm font-semibold hidden md:table-cell">Sekolah</th>';
        html +=
          '<th class="px-4 py-3 text-left text-sm font-semibold hidden lg:table-cell">Jabatan</th>';
        html +=
          '<th class="px-4 py-3 text-left text-sm font-semibold">Tipe Jari</th>';
        html +=
          '<th class="px-4 py-3 text-left text-sm font-semibold">Indikasi</th>';
        html +=
          '<th class="px-4 py-3 text-center text-sm font-semibold">Aksi</th>';
        html += "</tr>";
        html += "</thead>";
        html += '<tbody class="divide-y divide-gray-200">';

        dataStore.forEach((item) => {
          const indikasiColor =
            item.indikasi === "positif"
              ? "bg-red-100 text-red-800"
              : "bg-green-100 text-green-800";
          html += `<tr class="hover:bg-gray-50 transition-colors duration-200">
                  <td class="px-4 py-3 text-sm text-gray-600">${
                    item.timestamp
                  }</td>
                  <td class="px-4 py-3 text-sm font-medium text-gray-900">${
                    item.nama
                  }</td>
                  <td class="px-4 py-3 text-sm text-gray-600 hidden sm:table-cell">${
                    item.nohp
                  }</td>
                  <td class="px-4 py-3 text-sm text-gray-600 hidden md:table-cell">${
                    item.sekolah
                  }</td>
                  <td class="px-4 py-3 text-sm text-gray-600 hidden lg:table-cell">${
                    item.jabatan || "N/A"
                  }</td>
                  <td class="px-4 py-3 text-sm text-gray-600">${
                    item.tipejari
                  }</td>
                  <td class="px-4 py-3">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${indikasiColor}">
                          ${item.indikasi}
                      </span>
                  </td>
                  <td class="px-4 py-3 text-center">
                      <div class="flex justify-center space-x-2">
                          <button onclick="viewDetails(${
                            item.id
                          })" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors duration-200">
                              👁️
                          </button>
                          <button onclick="deleteData(${
                            item.id
                          })" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors duration-200">
                              🗑️
                          </button>
                      </div>
                  </td>
              </tr>`;
        });

        html += "</tbody></table></div>";
        display.innerHTML = html;
        updateStats();
      }

      function viewDetails(id) {
        const item = dataStore.find((data) => data.id === id);
        if (item) {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50";
          modal.innerHTML = `
                  <div class="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
                      <h3 class="text-lg font-bold mb-4 text-gray-800">Detail Data</h3>
                      <div class="space-y-3">
                          <div><strong>Nama:</strong> ${item.nama}</div>
                          <div><strong>No. HP:</strong> ${item.nohp}</div>
                          <div><strong>Sekolah:</strong> ${item.sekolah}</div>
                          <div><strong>Jabatan:</strong> ${
                            item.jabatan || "Tidak ada"
                          }</div>
                          <div><strong>Tipe Jari:</strong> ${
                            item.tipejari
                          }</div>
                          <div><strong>Indikasi:</strong> 
                              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                item.indikasi === "positif"
                                  ? "bg-red-100 text-red-800"
                                  : "bg-green-100 text-green-800"
                              }">
                                  ${item.indikasi}
                              </span>
                          </div>
                          <div><strong>Keterangan:</strong> ${
                            item.keterangan || "Tidak ada"
                          }</div>
                          <div><strong>Follow Up Date:</strong> ${
                            item.followup || "Tidak ada"
                          }</div>
                          <div><strong>Timestamp:</strong> ${
                            item.timestamp
                          }</div>
                      </div>
                      <button onclick="this.parentElement.parentElement.remove()" class="mt-4 w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-200">
                          Tutup
                      </button>
                  </div>
              `;
          document.body.appendChild(modal);

          // Close modal when clicking outside
          modal.addEventListener("click", function (e) {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }
      }

      function deleteData(id) {
        if (confirm("Apakah Anda yakin ingin menghapus data ini?")) {
          dataStore = dataStore.filter((item) => item.id !== id);
          localStorage.setItem("userData", JSON.stringify(dataStore));
          updateDataDisplay();
        }
      }

      function clearAllData() {
        if (
          confirm(
            "Apakah Anda yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!"
          )
        ) {
          dataStore = [];
          localStorage.setItem("userData", JSON.stringify(dataStore));
          updateDataDisplay();
        }
      }

      function exportData() {
        if (dataStore.length === 0) {
          alert("Tidak ada data untuk diekspor");
          return;
        }

        const dataStr = JSON.stringify(dataStore, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `data_backup_${
          new Date().toISOString().split("T")[0]
        }.json`;
        link.click();
        URL.revokeObjectURL(url);
      }

      function importData() {
        document.getElementById("fileInput").click();
      }

      function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const importedData = JSON.parse(e.target.result);
            if (Array.isArray(importedData)) {
              if (
                confirm(
                  "Import data akan menggantikan data yang ada. Lanjutkan?"
                )
              ) {
                dataStore = importedData;
                localStorage.setItem("userData", JSON.stringify(dataStore));
                updateDataDisplay();
                alert("Data berhasil diimport!");
              }
            } else {
              alert("Format file tidak valid");
            }
          } catch (error) {
            alert("Error membaca file: " + error.message);
          }
        };
        reader.readAsText(file);
      }

      // Initialize display when page loads
      document.addEventListener("DOMContentLoaded", function () {
        updateDataDisplay();
      });

      // Initialize display immediately
      updateDataDisplay();
    </script>
  </body>
</html>
