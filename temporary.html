<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Temporary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
      }
      .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
      }
      .autocomplete-items div:hover {
        background-color: #e9e9e9;
      }
      .autocomplete-active {
        background-color: #1e40af !important;
        color: #ffffff;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-green-50 to-emerald-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <div class="mb-8 text-center">
        <div class="bg-white rounded-2xl p-6 shadow-xl">
          <img
            src="https://tesdia.id/wp-content/uploads/2023/03/cropped-hanya-logo-DIA.webp"
            alt="Logo TesDIA"
            class="mx-auto mb-4 w-24 h-24 rounded-full shadow-lg"
          />
          <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
            TesDIA Temporary Manager
          </h1>
          <p class="text-lg text-gray-600">
            Dermatoglyphics, Intelligence, Analysis
          </p>
          <p class="text-sm text-gray-500 mt-1">Form Input Data Temporary</p>
        </div>
      </div>

      <div class="max-w-4xl mx-auto">
        <form id="temporaryForm" class="bg-white rounded-lg shadow-md p-6">
          <h2
            class="text-2xl font-bold text-gray-800 mb-6 border-b-4 border-green-500 pb-3"
          >
            üìù Form Input Temporary
          </h2>
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="no">
              No
            </label>
            <input
              type="text"
              id="no"
              name="no"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            />
          </div>

          <div class="mb-4 relative">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="nama_pembayar"
            >
              Nama Pembayar
            </label>
            <input
              type="text"
              id="nama_pembayar"
              name="nama_pembayar"
              required
              autocomplete="off"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            />
            <div
              id="namaPembayarAutocomplete"
              class="autocomplete-items hidden"
            ></div>
          </div>

          <div class="mb-4 relative">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="nama_yang_dites"
            >
              Nama yang di Tes
            </label>
            <input
              type="text"
              id="nama_yang_dites"
              name="nama_yang_dites"
              required
              autocomplete="off"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            />
            <div
              id="namaYangDitesAutocomplete"
              class="autocomplete-items hidden"
            ></div>
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="nominal"
            >
              Nominal
            </label>
            <input
              type="number"
              id="nominal"
              name="nominal"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            />
          </div>

          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="metode_pembayaran"
            >
              Metode Pembayaran
            </label>
            <select
              id="metode_pembayaran"
              name="metode_pembayaran"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
            >
              <option value="">Pilih Metode</option>
              <option value="Tunai">Tunai</option>
              <option value="Transfer Bank">Transfer Bank</option>
              <option value="E-Wallet">E-Wallet</option>
              <option value="QRIS">QRIS</option>
            </select>
          </div>

          <button
            type="submit"
            class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded hover:bg-green-700 focus:outline-none focus:shadow-outline"
          >
            Simpan Data Temporary
          </button>
        </form>

        <div id="responseMessage" class="mt-4 text-center"></div>

        <!-- Tabel Data Temporary -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">
              üìä Data Temporary TesDIA
            </h2>
            <div class="flex items-center space-x-4">
              <input
                type="text"
                id="searchInput"
                placeholder="üîç Cari data temporary..."
                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
              />
              <select
                id="limitSelect"
                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
              >
                <option value="10">10 per halaman</option>
                <option value="20">20 per halaman</option>
                <option value="30">30 per halaman</option>
                <option value="50">50 per halaman</option>
              </select>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table id="temporaryTable" class="w-full table-auto">
              <thead>
                <tr class="bg-gray-200">
                  <th class="px-4 py-2 text-left">No</th>
                  <th class="px-4 py-2 text-left">Nama Pembayar</th>
                  <th class="px-4 py-2 text-left">Nama Yang di Tes</th>
                  <th class="px-4 py-2 text-left">Nominal</th>
                  <th class="px-4 py-2 text-left">Metode Pembayaran</th>
                </tr>
              </thead>
              <tbody id="temporaryTableBody">
                <!-- Data akan di-load di sini -->
              </tbody>
            </table>
          </div>

          <div id="pagination" class="mt-4 flex justify-between items-center">
            <div id="paginationInfo"></div>
            <div class="flex space-x-2">
              <button
                id="prevBtn"
                class="px-3 py-1 border rounded hover:bg-gray-100"
              >
                Previous
              </button>
              <div id="pageNumbers" class="flex space-x-1"></div>
              <button
                id="nextBtn"
                class="px-3 py-1 border rounded hover:bg-gray-100"
              >
                Next
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwLG1hchiZOEnReay3Haxgufq5rloB5aUsn7CvU6MUYofXofp13I9iePL0YjuMK8iYnjA/exec";
      let pembayarNames = [];
      let yangDitesNames = [];

      // Variables for pagination
      let currentPage = 1;
      let currentLimit = 10;
      let totalPages = 1;
      let searchQuery = "";

      // Load existing names
      async function loadNames() {
        try {
          // Load from customer sheet for "nama yang di tes"
          const customerResponse = await fetch(
            `${APPS_SCRIPT_URL}?sheet=customer`
          );
          const customerResult = await customerResponse.json();
          if (customerResult.success) {
            yangDitesNames = [
              ...new Set(
                customerResult.data
                  .map((item) => item.nama)
                  .filter((name) => name)
              ),
            ];
          }

          // Load from temporary sheet for "nama pembayar"
          const tempResponse = await fetch(
            `${APPS_SCRIPT_URL}?sheet=temporary`
          );
          const tempResult = await tempResponse.json();
          if (tempResult.success) {
            pembayarNames = [
              ...new Set(
                tempResult.data
                  .map((item) => item.nama_pembayar)
                  .filter((name) => name)
              ),
            ];
          }
        } catch (error) {
          console.error("Error loading names:", error);
        }
      }

      // Load table data with pagination
      async function loadTableData() {
        try {
          const response = await fetch(
            `${APPS_SCRIPT_URL}?sheet=temporary&pagination=true&page=${currentPage}&limit=${currentLimit}&search=${encodeURIComponent(
              searchQuery
            )}`
          );
          const result = await response.json();

          if (result.success) {
            displayTableData(result.data);
            updatePagination(result.pagination);
          }
        } catch (error) {
          console.error("Error loading table data:", error);
        }
      }

      // Display table data
      function displayTableData(data) {
        const tbody = document.getElementById("temporaryTableBody");
        tbody.innerHTML = "";

        if (data.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center py-4 text-gray-500">Tidak ada data</td></tr>';
          return;
        }

        data.forEach((row) => {
          const tr = document.createElement("tr");
          tr.className = "border-b hover:bg-gray-50";
          tr.innerHTML = `
                  <td class="px-4 py-2">${row.no}</td>
                  <td class="px-4 py-2">${row.namapembayar}</td>
                  <td class="px-4 py-2">${row.namayangdites}</td>
                  <td class="px-4 py-2">Rp ${parseInt(
                    row.nominal || 0
                  ).toLocaleString("id-ID")}</td>
                  <td class="px-4 py-2">${row.metodepembayaran}</td>
              `;
          tbody.appendChild(tr);
        });
      }

      // Update pagination UI
      function updatePagination(pagination) {
        currentPage = pagination.currentPage;
        totalPages = pagination.totalPages;

        document.getElementById("paginationInfo").textContent = `Menampilkan ${
          (currentPage - 1) * currentLimit + 1
        } - ${Math.min(
          currentPage * currentLimit,
          pagination.totalItems
        )} dari ${pagination.totalItems} data`;

        // Update page numbers
        const pageNumbers = document.getElementById("pageNumbers");
        pageNumbers.innerHTML = "";

        const maxPagesToShow = 5;
        let startPage = Math.max(
          1,
          currentPage - Math.floor(maxPagesToShow / 2)
        );
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
          startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.className = `px-3 py-1 border rounded ${
            i === currentPage ? "bg-blue-500 text-white" : "hover:bg-gray-100"
          }`;
          btn.onclick = () => goToPage(i);
          pageNumbers.appendChild(btn);
        }

        document.getElementById("prevBtn").disabled = currentPage === 1;
        document.getElementById("nextBtn").disabled =
          currentPage === totalPages;
      }

      // Pagination controls
      function goToPage(page) {
        currentPage = page;
        loadTableData();
      }

      document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          loadTableData();
        }
      });

      document.getElementById("nextBtn").addEventListener("click", () => {
        if (currentPage < totalPages) {
          currentPage++;
          loadTableData();
        }
      });

      document.getElementById("limitSelect").addEventListener("change", (e) => {
        currentLimit = parseInt(e.target.value);
        currentPage = 1;
        loadTableData();
      });

      document.getElementById("searchInput").addEventListener("input", (e) => {
        searchQuery = e.target.value;
        currentPage = 1;
        loadTableData();
      });

      // Autocomplete function (same as in customer.html)
      function autocomplete(inp, arr) {
        let currentFocus;

        inp.addEventListener("input", function (e) {
          let a,
            b,
            i,
            val = this.value;
          closeAllLists();
          if (!val) return false;
          currentFocus = -1;
          a = document.createElement("DIV");
          a.setAttribute("id", this.id + "AutocompleteList");
          a.setAttribute("class", "autocomplete-items");
          this.parentNode.appendChild(a);

          for (i = 0; i < arr.length; i++) {
            if (
              arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()
            ) {
              b = document.createElement("DIV");
              b.innerHTML =
                "<strong>" + arr[i].substr(0, val.length) + "</strong>";
              b.innerHTML += arr[i].substr(val.length);
              b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
              b.addEventListener("click", function (e) {
                inp.value = this.getElementsByTagName("input")[0].value;
                closeAllLists();
              });
              a.appendChild(b);
            }
          }
        });

        inp.addEventListener("keydown", function (e) {
          var x = document.getElementById(this.id + "AutocompleteList");
          if (x) x = x.getElementsByTagName("div");
          if (e.keyCode == 40) {
            currentFocus++;
            addActive(x);
          } else if (e.keyCode == 38) {
            currentFocus--;
            addActive(x);
          } else if (e.keyCode == 13) {
            e.preventDefault();
            if (currentFocus > -1) {
              if (x) x[currentFocus].click();
            }
          }
        });

        function addActive(x) {
          if (!x) return false;
          removeActive(x);
          if (currentFocus >= x.length) currentFocus = 0;
          if (currentFocus < 0) currentFocus = x.length - 1;
          x[currentFocus].classList.add("autocomplete-active");
        }

        function removeActive(x) {
          for (var i = 0; i < x.length; i++) {
            x[i].classList.remove("autocomplete-active");
          }
        }

        function closeAllLists(elmnt) {
          var x = document.getElementsByClassName("autocomplete-items");
          for (var i = 0; i < x.length; i++) {
            if (elmnt != x[i] && elmnt != inp) {
              x[i].parentNode.removeChild(x[i]);
            }
          }
        }

        document.addEventListener("click", function (e) {
          closeAllLists(e.target);
        });
      }

      // Form submission
      document
        .getElementById("temporaryForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData);

          try {
            const response = await fetch(`${APPS_SCRIPT_URL}?sheet=temporary`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            const result = await response.json();
            const messageDiv = document.getElementById("responseMessage");

            if (result.success) {
              messageDiv.innerHTML =
                '<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">Data berhasil disimpan!</div>';
              e.target.reset();
              // Reload names after successful submission
              loadNames();
            } else {
              messageDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Error: ${result.message}</div>`;
            }
          } catch (error) {
            document.getElementById(
              "responseMessage"
            ).innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Error: ${error.message}</div>`;
          }
        });

      // Initialize
      loadNames();
      loadTableData(); // Load table data on page load
      autocomplete(document.getElementById("nama_pembayar"), pembayarNames);
      autocomplete(document.getElementById("nama_yang_dites"), yangDitesNames);
    </script>
  </body>
</html>
