<!-- index3.html -->
<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Akun Pembayaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-lg">
      <h2 class="text-2xl font-bold mb-6 text-center">Form Akun Pembayaran</h2>
      <form id="akunForm" class="space-y-4">
        <div>
          <label for="nomorakun" class="block font-semibold mb-1"
            >Nomor Akun *</label
          >
          <input
            type="text"
            id="nomorakun"
            name="nomorakun"
            required
            class="w-full border px-3 py-2 rounded"
          />
        </div>
        <div>
          <label for="namalengkap" class="block font-semibold mb-1"
            >Nama Lengkap *</label
          >
          <input
            type="text"
            id="namalengkap"
            name="namalengkap"
            required
            class="w-full border px-3 py-2 rounded"
          />
        </div>
        <div>
          <label for="tanggaltes" class="block font-semibold mb-1"
            >Tanggal Tes *</label
          >
          <input
            type="date"
            id="tanggaltes"
            name="tanggaltes"
            required
            class="w-full border px-3 py-2 rounded"
          />
        </div>
        <div>
          <label for="tanggalbayar" class="block font-semibold mb-1"
            >Tanggal Bayar</label
          >
          <input
            type="date"
            id="tanggalbayar"
            name="tanggalbayar"
            class="w-full border px-3 py-2 rounded"
          />
        </div>
        <div>
          <label for="nominalbayar" class="block font-semibold mb-1"
            >Nominal Bayar *</label
          >
          <select
            id="nominalbayar"
            name="nominalbayar"
            required
            class="w-full border px-3 py-2 rounded"
          >
            <option value="">Pilih nominal</option>
            <option value="350000">Rp 350.000 (Lunas)</option>
            <option value="0">Rp 0 (Belum Lunas)</option>
          </select>
        </div>
        <div>
          <label for="alamat" class="block font-semibold mb-1">Alamat</label>
          <textarea
            id="alamat"
            name="alamat"
            rows="2"
            class="w-full border px-3 py-2 rounded"
          ></textarea>
        </div>
        <button
          type="submit"
          class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 transition"
        >
          Simpan
        </button>
      </form>
      <div id="resultMsg" class="mt-4 text-center"></div>
      <div id="dataDisplay" class="mt-8 overflow-x-auto"></div>
    </div>
    <script>
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwnwHBtoiPCK1NNtCjhry8p53tm2SyP-RxXyDgX8W7x2t23pkr21kPWPz1QjkSg2Exejg/exec";
      document
        .getElementById("akunForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = {
            nomorakun: formData.get("nomorakun"),
            namalengkap: formData.get("namalengkap"),
            tanggaltes: formData.get("tanggaltes"),
            tanggalbayar: formData.get("tanggalbayar"),
            nominalbayar: formData.get("nominalbayar"),
            alamat: formData.get("alamat"),
          };
          document.getElementById("resultMsg").textContent = "Menyimpan...";
          try {
            const response = await fetch(APPS_SCRIPT_URL, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body:
                "data=" +
                encodeURIComponent(JSON.stringify(data)) +
                "&sheet=akun",
            });
            const result = await response.json();
            if (result.success) {
              document.getElementById("resultMsg").textContent =
                "‚úÖ Data berhasil disimpan!";
              e.target.reset();
            } else {
              document.getElementById("resultMsg").textContent =
                "‚ùå Gagal menyimpan: " + result.message;
            }
          } catch (err) {
            document.getElementById("resultMsg").textContent =
              "‚ùå Error: " + err.message;
          }
        });

      // Data store
      let akunStore = [];
      let isOnline = navigator.onLine;
      let lastSyncTime = null;

      // Sync data from Google Sheets
      async function syncDataFromSheets(showIndicator = true) {
        try {
          if (showIndicator) {
            document.getElementById("resultMsg").textContent =
              "üîÑ Syncing data...";
          }
          const response = await fetch(
            APPS_SCRIPT_URL + "?action=get&sheet=akun",
            { method: "GET" }
          );
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              akunStore = result.data;
              updateDataDisplay();
              lastSyncTime = new Date();
              if (showIndicator) {
                document.getElementById("resultMsg").textContent =
                  "‚úÖ Sync sukses";
              }
            }
          } else {
            throw new Error("Failed to fetch data");
          }
        } catch (err) {
          document.getElementById("resultMsg").textContent =
            "‚ùå Sync error: " + err.message;
        }
      }

      // Tampilkan data ke tabel
      function updateDataDisplay() {
        const table = document.getElementById("dataDisplay");
        if (!akunStore.length) {
          table.innerHTML =
            '<div class="text-gray-500 text-center py-8 italic">Belum ada data akun pembayaran</div>';
          return;
        }
        const rows = akunStore
          .map(
            (d, i) => `
      <tr class="hover:bg-gray-50 transition-colors duration-200">
        <td class="px-2 py-2 text-xs">${i + 1}</td>
        <td class="px-2 py-2 text-xs">${d.nomorakun || "-"}</td>
        <td class="px-2 py-2 text-xs">${d.namalengkap || "-"}</td>
        <td class="px-2 py-2 text-xs">${d.tanggaltes || "-"}</td>
        <td class="px-2 py-2 text-xs">${d.tanggalbayar || "-"}</td>
        <td class="px-2 py-2 text-xs">${formatCurrency(d.nominalbayar)}</td>
        <td class="px-2 py-2 text-xs">${d.alamat || "-"}</td>
        <td class="px-2 py-2 text-xs font-semibold ${
          d.statuspembayaran === "Lunas" ? "text-green-600" : "text-red-600"
        }">${d.statuspembayaran || "-"}</td>
      </tr>
    `
          )
          .join("");
        table.innerHTML = `
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto border-collapse bg-white rounded-lg overflow-hidden shadow-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-2 text-left text-xs font-semibold text-gray-600">#</th>
              <th class="px-2 py-2 text-left text-xs font-semibold text-gray-600">Nomor Akun</th>
              <th class="px-2 py-2 text-left text-xs font-semibold text-gray-600">Nama Lengkap</th>
              <th class="px-2 py-2 text-left text-xs font-semibold text-gray-600">Tanggal Tes</th>
              <th class="px-2 py-2 text-left text-xs font-semibold text-gray-600">Tanggal Bayar</th>
              <th class="px-2 py-2 text-left text-xs font-semibold text-gray-600">Nominal Bayar</th>
              <th class="px-2 py-2 text-left text-xs font-semibold text-gray-600">Alamat</th>
              <th class="px-2 py-2 text-left text-xs font-semibold text-gray-600">Status Pembayaran</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            ${rows}
          </tbody>
        </table>
      </div>
    `;
      }

      // Format currency
      function formatCurrency(amount) {
        const num = parseInt(amount) || 0;
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        }).format(num);
      }

      // Sync saat halaman dibuka
      document.addEventListener("DOMContentLoaded", () => {
        syncDataFromSheets(true);
      });
    </script>
  </body>
</html>
